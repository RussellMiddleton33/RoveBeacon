<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>RoveMaps - Fleet Tracking Demo</title>
  
  <!-- MapLibre GL JS -->
  <link href="https://unpkg.com/maplibre-gl@5.1.0/dist/maplibre-gl.css" rel="stylesheet" />
  <script src="https://unpkg.com/maplibre-gl@5.1.0/dist/maplibre-gl.js"></script>

  <!-- RoveMaps You Are Here SDK -->
  <script src="../dist/rovemaps-you-are-here.umd.cjs"></script>

  <style>
    body { margin: 0; padding: 0; font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif; }
    #map { position: absolute; top: 0; bottom: 0; width: 100%; }
    #controls {
      position: absolute;
      top: 20px;
      left: 20px;
      background: white;
      padding: 20px;
      border-radius: 12px;
      box-shadow: 0 4px 12px rgba(0,0,0,0.15);
      z-index: 10;
      width: 300px;
    }
    h1 { margin: 0 0 10px 0; font-size: 1.2rem; color: #333; }
    p { margin: 0 0 15px 0; font-size: 0.9rem; color: #666; line-height: 1.4; }
    .legend { display: flex; flex-direction: column; gap: 8px; margin-top: 15px; }
    .legend-item { display: flex; align-items: center; gap: 10px; font-size: 0.85rem; }
    .dot { width: 12px; height: 12px; border-radius: 50%; border: 2px solid white; box-shadow: 0 1px 3px rgba(0,0,0,0.3); }
    button {
      background: #4285F4;
      color: white;
      border: none;
      padding: 10px 15px;
      border-radius: 6px;
      font-weight: 600;
      cursor: pointer;
      width: 100%;
      margin-top: 10px;
    }
    button:hover { background: #3367d6; }
  </style>
</head>
<body>

  <div id="controls">
    <h1>Fleet Tracking Demo</h1>
    <p>Demonstrating multiple active beacons with different status modes simulated around your location.</p>
    
    <div id="status">Locating you...</div>
    
    <div class="legend">
      <div class="legend-item">
        <div class="dot" style="background: #4285F4"></div>
        <span>You (High Confidence)</span>
      </div>
      <div class="legend-item">
        <div class="dot" style="background: #34A853"></div>
        <span>Teammate (Active)</span>
      </div>
      <div class="legend-item">
        <div class="dot" style="background: #FF9500"></div>
        <span>Warning (Low Battery/Signal)</span>
      </div>
      <div class="legend-item">
        <div class="dot" style="background: #FF3B30"></div>
        <span>Danger (Emergency/Offline)</span>
      </div>
    </div>

    <button onclick="scrambleLocations()">Scramble Locations</button>
  </div>

  <div id="map"></div>

  <script>
    // 1. Initialize Map
    const map = new maplibregl.Map({
      container: 'map',
      style: 'https://demotiles.maplibre.org/style.json', // Free open style
      center: [-74.006, 40.7128], // Default to NYC
      zoom: 14,
      pitch: 45
    });

    const { MapLibreUserMarker, GeolocationProvider } = RoveMapsYouAreHere;
    
    // Store our markers
    const markers = [];
    let userMarker;
    let currentLocation = { lng: -74.006, lat: 40.7128 }; // Default

    // 2. Setup Geolocation to find the user
    const geo = new GeolocationProvider();

    geo.on('update', (loc) => {
      // Update map center only on first load
      if (!userMarker) {
        currentLocation = { lng: loc.longitude, lat: loc.latitude };
        map.flyTo({ center: [loc.longitude, loc.latitude], zoom: 15 });
        initializeFleet();
      }
      
      // Update the "You" marker
      if (!userMarker) {
        userMarker = new MapLibreUserMarker({
          color: 0x4285F4,
          pulseSpeed: 0.5,
          showAccuracyRing: true
        }).addTo(map);
      }
      
      userMarker.setLngLat([loc.longitude, loc.latitude]);
      userMarker.setAccuracy(loc.accuracy);
      userMarker.setHeading(loc.heading, loc.speed);
      
      document.getElementById('status').innerText = `Tracking active. Accuracy: ${Math.round(loc.accuracy)}m`;
    });

    geo.on('error', (err) => {
      console.warn("Geolocation error:", err);
      document.getElementById('status').innerText = "Location access denied. Using mock NYC location.";
      initializeFleet(); // Fallback to NYC
    });

    geo.start().catch(() => {
      // If start fails (e.g. permission denied), init anyway
      initializeFleet();
    });

    // 3. Create "Fleet" of random markers
    function initializeFleet() {
      // Clear existing
      markers.forEach(m => m.remove());
      markers.length = 0;

      const fleetSize = 8;
      
      for (let i = 0; i < fleetSize; i++) {
        // Random offset from user (approx 500m radius)
        const latOffset = (Math.random() - 0.5) * 0.01;
        const lngOffset = (Math.random() - 0.5) * 0.01;
        
        // Pick a random state
        const rand = Math.random();
        let config = {};
        let state = 'high';
        
        if (rand > 0.8) {
          // Danger
          config = { color: 0xFF3B30, pulseSpeed: 0.8 }; // Red
          state = 'danger';
        } else if (rand > 0.6) {
          // Warning
          config = { color: 0xFF9500, pulseSpeed: 0.4 }; // Orange
          state = 'warning';
        } else {
          // Normal Teammate
          config = { color: 0x34A853, pulseSpeed: 0.2 }; // Green
          state = 'high';
        }

        const marker = new MapLibreUserMarker({
          ...config,
          showDirectionCone: true,
          showAccuracyRing: true
        });

        marker.addTo(map);
        marker.setLngLat([currentLocation.lng + lngOffset, currentLocation.lat + latOffset]);
        marker.setConfidence(state);
        
        // Simulate random movement
        simulateMovement(marker, currentLocation.lng + lngOffset, currentLocation.lat + latOffset);
        
        markers.push(marker);
      }
    }

    // 4. Simulate random "wandering" behavior
    function simulateMovement(marker, baseLng, baseLat) {
      let lng = baseLng;
      let lat = baseLat;
      let heading = Math.random() * 360;

      setInterval(() => {
        // Wander
        heading += (Math.random() - 0.5) * 30;
        const speed = 2 + Math.random(); // 2-3 m/s
        
        // Move slightly in heading direction
        const rads = heading * Math.PI / 180;
        lng += Math.cos(rads) * 0.00005;
        lat += Math.sin(rads) * 0.00005;

        marker.setLngLat([lng, lat]);
        marker.setHeading(heading, speed);
      }, 1000 + Math.random() * 1000); // Random update interval 1-2s
    }

    function scrambleLocations() {
      initializeFleet();
    }

  </script>
</body>
</html>
